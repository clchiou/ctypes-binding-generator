'''Package for automatic generation of ctypes bindings from C sources.'''

from cbind.ctypes_binding import CtypesBindingGenerator
from cbind.macro import MacroGenerator


DEFAULT_LOADER_CODES = '''\
import sys
if sys.platform == 'darwin':
    _lib = CDLL('{darwin_library}', RTLD_GLOBAL)
elif sys.platform == 'win32' or sys.platform == 'cygwin':
    _lib = windll.LoadLibrary('{windows_library}')
else:
    _lib = cdll.LoadLibrary('{posix_library}')
del sys\n
'''


def parse_args():
    '''Parse command-line arguments.'''
    import argparse
    parser = argparse.ArgumentParser(description='''
            Generate ctypes binding from C source files with clang.
            ''')
    parser.add_argument('-v', action='count', default=0,
            help='verbosity')
    parser.add_argument('-i', metavar='SOURCE', action='append',
            help='C source file')
    parser.add_argument('-o', metavar='OUTPUT', default='-',
            help='output file, default to \'-\' (stdout)')

    group = parser.add_argument_group(title='library loader arguments',
            description='''
            Insert Python codes that load the library. If only the library is
            provided, default loader codes are inserted.
            ''')
    group.add_argument('-l', metavar='LIBRARY',
            help='Name of the library in POSIX systems')
    group.add_argument('--win-dll', metavar='LIBRARY',
            help='Name of the library in Windows systems')
    group.add_argument('--darwin-lib', metavar='LIBRARY',
            help='Name of the library in Darwin systems')
    group.add_argument('--loader-codes', metavar='FILE', type=file,
            help='Python loader codes')

    group = parser.add_argument_group(title='macro parser arguments',
            description='''
            Translate C macros into Python codes (experimental). The PATTERN
            argument will match macro name.
            ''')
    group.add_argument('--macro-enable', action='store_true',
            help='enable macro translation')
    group.add_argument('--macro-include', metavar='PATTERN',
            help='translate these macros as well')
    group.add_argument('--macro-exclude', metavar='PATTERN',
            help='do not translate these macros')
    group.add_argument('--macro-int', metavar='PATTERN',
            help='assure that these macros are integer constants')
    parser.add_argument('ccargs', metavar='CCARGS', nargs=argparse.REMAINDER,
            help='arguments passed to clang, separated by an optional \'--\' '
                 'from those passed to %(prog)s')

    args = parser.parse_args()
    return parser, args


def insert_loader(args, output):
    '''Insert library loader.'''
    if not (args.l or args.darwin_lib or args.win_dll):
        return
    if args.loader_codes:
        loader_codes = args.loader_codes.read()
    else:
        loader_codes = DEFAULT_LOADER_CODES
    output.write(loader_codes.format(posix_library=args.l,
        darwin_library=args.darwin_lib,
        windows_library=args.win_dll))


def main():
    '''Main function.'''
    import logging
    import sys

    parser, args = parse_args()
    if not args.i:
        parser.print_usage()
        return 0

    logging.basicConfig(format='%(filename)s: %(message)s')
    if args.v > 0:
        logging.getLogger().setLevel(logging.INFO)

    if args.ccargs and args.ccargs[0] == '--':
        clang_args = args.ccargs[1:]
    else:
        clang_args = args.ccargs

    cbgen = CtypesBindingGenerator()
    for c_src in args.i:
        cbgen.parse(c_src, args=clang_args)
    if args.macro_enable:
        mcgen = MacroGenerator(
                macro_include=args.macro_include,
                macro_exclude=args.macro_exclude,
                macro_int=args.macro_int)
        for c_src in args.i:
            mcgen.parse(c_src, args=clang_args)

    if args.o == '-':
        output = sys.stdout
    else:
        output = open(args.o, 'w')
    with output:
        output.write('# This is generated by %s and should not be edited.\n'
                'from ctypes import *\n\n' % parser.prog)
        insert_loader(args, output)
        cbgen.generate(output)
        if args.macro_enable:
            mcgen.generate(output)

    return 0
